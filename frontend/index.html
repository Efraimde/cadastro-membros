<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Membros</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family:Arial, sans-serif; }
    body { background:#f3f4f6; color:#111827; padding:20px; }
    h1 { text-align:center; margin-bottom:20px; color:#1f2937; }
    .container { max-width:1100px; margin:0 auto; }
    .card { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.1); margin-bottom:20px; }
    #loginContainer { display:flex; justify-content:center; align-items:center; height:100vh; }
    #loginForm { width:100%; max-width:400px; }
    #loginForm h2 { text-align:center; margin-bottom:15px; color:#1f2937; }
    form label { margin-bottom:6px; font-weight:bold; font-size:14px; }
    form input, form select { width:100%; padding:10px; margin-bottom:12px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; }
    form button { width:100%; padding:12px; background:#3b82f6; color:#fff; font-weight:bold; border:none; border-radius:8px; cursor:pointer; transition:0.3s; }
    form button:hover { background:#2563eb; }
    .form-grid { display:grid; grid-template-columns: repeat(2,1fr); gap:20px; }
    .form-item { display:flex; flex-direction:column; }
    .form-full { grid-column: span 2; }
    @media(max-width:700px){
      .form-grid { grid-template-columns:1fr; }
      .form-full { grid-column: span 1; }
    }
    .table-container { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    th, td { padding:12px; text-align:left; vertical-align:middle; }
    th { background:#3b82f6; color:#fff; font-size:14px; }
    td { font-size:14px; }
    tr:nth-child(even) { background:#f9fafb; }
    tr:hover { background:#e0f2fe; }
    /* Botões */
    .btn { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold; margin:2px; white-space:nowrap; }
    .btn-status { background:#10b981; color:#fff; }
    .btn-status.inativo { background:#ef4444; }
    .btn-carteirinha { background:#f59e0b; color:#fff; }
    .btn-editar { background:#3b82f6; color:#fff; }
    .btn-excluir { background:#ef4444; color:#fff; }
    .btn:hover { opacity:0.85; }

    /* QR + ações na mesma linha */
    .acoes-container { 
      display:flex; 
      align-items:center; 
      flex-wrap:wrap; 
      gap:6px; 
    }
    .acoes-container img, 
    .acoes-container canvas { 
      border:1px solid #ddd; 
      border-radius:6px; 
      width:80px; 
      height:80px; 
    }

    /* Responsividade */
    @media(max-width:700px){
      table { font-size:12px; }
      th, td { padding:8px; }
      
      .acoes-container { 
        flex-wrap:nowrap; 
        overflow-x:auto; 
        padding:4px 0; 
      }
      .acoes-container .btn { 
        flex:0 0 auto; 
        font-size:11px; 
        padding:5px 8px; 
      }
      .acoes-container img, 
      .acoes-container canvas { 
        width:50px; 
        height:50px; 
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <!-- Login -->
  <div id="loginContainer">
    <form id="loginForm" class="card">
      <h2>Login Administrativo</h2>
      <div class="erro" id="erro"></div>
      <label for="usuario">Usuário</label>
      <input type="text" id="usuario" required>
      <label for="senha">Senha</label>
      <input type="password" id="senha" required>
      <div class="mostrar-senha">
        <input type="checkbox" id="toggleSenha">
        <label for="toggleSenha">Mostrar senha</label>
      </div>
      <button type="submit">Entrar</button>
    </form>
  </div>

  <!-- Aplicação -->
  <div id="app" style="display:none;">
    <div class="container">
      <div style="text-align:right; margin-bottom:10px;">
        <button id="btnSair" class="btn btn-excluir">Sair</button>
      </div>
      <h1>Cadastro de Membros</h1>

      <!-- Formulário -->
      <form id="form-membro" class="card form-grid">
        <div class="form-item">
          <label for="nome">Nome</label>
          <input type="text" id="nome" placeholder="Nome completo" required>
        </div>
        <div class="form-item">
          <label for="email">E-mail</label>
          <input type="email" id="email" placeholder="email@exemplo.com" required>
        </div>
        <div class="form-item">
          <label for="rg">RG</label>
          <input type="text" id="rg" placeholder="Digite o RG" required>
        </div>
        <div class="form-item">
          <label for="status">Status</label>
          <select id="status">
            <option value="ativo">Ativo</option>
            <option value="inativo">Inativo</option>
          </select>
        </div>
        <div class="form-full">
          <button type="submit">Cadastrar</button>
        </div>
      </form>

      <!-- Tabela -->
      <div class="card table-container">
        <table id="tabela-membros">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>E-mail</th>
              <th>RG</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const loginContainer = document.getElementById('loginContainer');
    const app = document.getElementById('app');
    const formLogin = document.getElementById('loginForm');
    const erro = document.getElementById('erro');
    const senhaInput = document.getElementById('senha');
    const toggleSenha = document.getElementById('toggleSenha');
    const btnSair = document.getElementById('btnSair');

    toggleSenha.addEventListener('change', () => {
      senhaInput.type = toggleSenha.checked ? 'text' : 'password';
    });

    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();
      const usuario = document.getElementById('usuario').value;
      const senha = senhaInput.value;
      const res = await fetch('/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ usuario, senha })
      });
      const data = await res.json();
      if(data.ok) {
        localStorage.setItem('logado','true');
        loginContainer.style.display='none';
        app.style.display='block';
        listarMembros();
      } else {
        erro.textContent = "Usuário ou senha incorretos!";
      }
    });

    btnSair.addEventListener('click', () => {
      localStorage.removeItem('logado');
      app.style.display = 'none';
      loginContainer.style.display = 'flex';
    });

    if(localStorage.getItem('logado') === 'true') {
      loginContainer.style.display='none';
      app.style.display='block';
      listarMembros();
    }

    const form = document.getElementById('form-membro');
    const tabela = document.getElementById('tabela-membros').querySelector('tbody');

    async function listarMembros() {
      const res = await fetch('/api/membros');
      const membros = await res.json();
      tabela.innerHTML='';
      membros.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.id}</td>
          <td>${m.nome}</td>
          <td>${m.email}</td>
          <td>${m.rg}</td>
          <td>
            <button class="btn btn-status ${m.status==='inativo'?'inativo':''}" onclick="alterarStatus(${m.id})">
              ${m.status.toUpperCase()}
            </button>
          </td>
          <td>
            <div class="acoes-container" id="acoes-${m.id}">
              <div id="qrcode-${m.id}"></div>
              <button class="btn btn-carteirinha" onclick="window.open('/status/${m.id}')">Carteirinha</button>
              <button class="btn btn-editar" onclick="editarMembro(${m.id})">Editar</button>
              <button class="btn btn-excluir" onclick="excluirMembro(${m.id})">Excluir</button>
            </div>
          </td>
        `;
        tabela.appendChild(tr);

        // QR Code pequeno
        const qrcodeDiv = document.getElementById(`qrcode-${m.id}`);
        new QRCode(qrcodeDiv, {
          text: `${window.location.origin}/status/${m.id}`,
          width: 80,
          height: 80
        });

        // Botão download QR
        const btnDownload = document.createElement('button');
        btnDownload.textContent = 'Download QR';
        btnDownload.className = 'btn btn-carteirinha';
        btnDownload.onclick = () => {
          const img = qrcodeDiv.querySelector('img') || qrcodeDiv.querySelector('canvas');
          let url = img.tagName === 'IMG' ? img.src : img.toDataURL('image/png');
          const a = document.createElement('a');
          a.href = url;
          a.download = `QR_${m.nome.replace(/\s/g,'_')}.png`;
          a.click();
        };
        document.getElementById(`acoes-${m.id}`).appendChild(btnDownload);
      });
    }

    async function cadastrarMembro(e) {
      e.preventDefault();
      const nome = document.getElementById('nome').value;
      const email = document.getElementById('email').value;
      const rg = document.getElementById('rg').value;
      const status = document.getElementById('status').value;
      await fetch('/api/membros', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ nome,email,rg,status })
      });
      form.reset();
      listarMembros();
    }

    async function alterarStatus(id) {
      const res = await fetch(`/api/membros/${id}`);
      const membro = await res.json();
      const novoStatus = membro.status==='ativo'?'inativo':'ativo';
      await fetch(`/api/membros/${id}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ status:novoStatus })
      });
      listarMembros();
    }

    async function excluirMembro(id) {
      if(!confirm('Deseja realmente excluir este membro?')) return;
      await fetch(`/api/membros/${id}`, { method:'DELETE' });
      listarMembros();
    }

    async function editarMembro(id) {
      const res = await fetch(`/api/membros/${id}`);
      const membro = await res.json();
      const nome = prompt('Nome:', membro.nome);
      if(nome===null) return;
      const email = prompt('E-mail:', membro.email);
      if(email===null) return;
      const rg = prompt('RG:', membro.rg);
      if(rg===null) return;
      const status = prompt('Status (ativo/inativo):', membro.status);
      if(status===null) return;
      await fetch(`/api/membros/${id}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ nome,email,rg,status })
      });
      listarMembros();
    }

    form.addEventListener('submit', cadastrarMembro);
  </script>
</body>
</html>
